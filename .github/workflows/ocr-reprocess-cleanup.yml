name: ocr-reprocess-cleanup

on:
  workflow_dispatch:
    inputs:
      api_base:
        description: "Agent API base URL (with or without /agent/v1)"
        required: true
        default: "https://app.welliam.codes/agent/v1"
      max_items:
        description: "Maximum vouchers to reprocess"
        required: true
        default: "200"
      include_non_invoice:
        description: "Include non_invoice vouchers"
        required: true
        default: true
        type: boolean
      wait:
        description: "Wait each run until success/failed"
        required: true
        default: true
        type: boolean
      dry_run:
        description: "Dry-run only (no API mutations)"
        required: true
        default: true
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install runtime deps
        run: |
          python -m pip install -U pip
          python -m pip install requests

      - name: Run OCR cleanup reprocess
        env:
          AGENT_API_KEY: ${{ secrets.PROD_AGENT_API_KEY != '' && secrets.PROD_AGENT_API_KEY || secrets.STAGING_AGENT_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${AGENT_API_KEY:-}" ]; then
            echo "Missing PROD_AGENT_API_KEY (or fallback STAGING_AGENT_API_KEY)." >&2
            exit 1
          fi
          ARGS=(
            --api-base "${{ inputs.api_base }}"
            --max-items "${{ inputs.max_items }}"
            --out reports/benchmark/ocr_reprocess_cleanup_latest.json
          )
          if [ "${{ inputs.include_non_invoice }}" = "true" ]; then
            ARGS+=(--include-non-invoice)
          fi
          if [ "${{ inputs.wait }}" = "true" ]; then
            ARGS+=(--wait)
          fi
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS+=(--dry-run)
          fi
          python scripts/maintenance/reprocess_ocr_vouchers.py "${ARGS[@]}"

      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ocr-reprocess-cleanup-report
          path: reports/benchmark/ocr_reprocess_cleanup_latest.json
          retention-days: 14
