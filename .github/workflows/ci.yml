name: ci

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install -e '.[dev,ui,graphs,ray]'

      - name: Lint
        run: |
          ruff check .

      - name: Tests
        run: |
          pytest -q

      - name: OpenAPI export is up-to-date
        run: |
          python scripts/export_openapi.py
          git diff --exit-code openapi/

      - name: Benchmark smoke (5 cases)
        run: |
          ./scripts/benchmark/fetch_or_generate_dataset.sh --cases 5
          python -m pytest tests/benchmark/test_benchmark_smoke.py -q

      - name: OCR field-level quality gate
        run: |
          python scripts/benchmark/eval_ocr_field_level.py \
            --gold scripts/benchmark/fixtures/ocr_field_level/gold.json \
            --pred scripts/benchmark/fixtures/ocr_field_level/predictions.json \
            --out reports/benchmark/ocr_field_level_ci.json \
            --html reports/benchmark/ocr_field_level_ci.html \
            --fail-on-gate

      - name: Upload OCR benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ocr-field-level-benchmark
          path: |
            reports/benchmark/ocr_field_level_ci.json
            reports/benchmark/ocr_field_level_ci.html
          retention-days: 14

  docker-build:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Build images
        run: |
          docker build -t openclaw-agent-erpx/agent-service:ci -f services/agent-service/Dockerfile .
          docker build -t openclaw-agent-erpx/agent-worker:ci -f services/agent-worker/Dockerfile .
          docker build -t openclaw-agent-erpx/agent-scheduler:ci -f services/agent-scheduler/Dockerfile .
          docker build -t openclaw-agent-erpx/erpx-mock-api:ci -f services/erpx-mock-api/Dockerfile .
          docker build -t openclaw-agent-erpx/ui:ci -f services/ui/Dockerfile .
