name: deploy-prod

on:
  workflow_dispatch:
    inputs:
      overlay:
        description: "Kustomize overlay to deploy"
        required: true
        default: "prod-6nodes"
        type: choice
        options:
          - prod
          - prod-6nodes
      namespace:
        description: "Target namespace"
        required: true
        default: "accounting-agent"
      image_tag:
        description: "Image tag to deploy (empty => current commit SHA)"
        required: false
        default: ""

permissions:
  contents: read
  packages: read

concurrency:
  group: accounting-agent-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Setup kustomize
        run: |
          set -euo pipefail
          curl -sL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.7.1/kustomize_v5.7.1_linux_amd64.tar.gz" \
            | tar xz -C /usr/local/bin
          kustomize version

      - name: Configure kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBECONFIG_B64 }}
        run: |
          set -euo pipefail
          if [ -z "${KUBECONFIG_B64:-}" ]; then
            echo "Missing secret: STAGING_KUBECONFIG_B64" >&2
            exit 1
          fi
          echo "${KUBECONFIG_B64}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> "$GITHUB_ENV"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Create/update image pull secret
        env:
          NS: ${{ inputs.namespace }}
          OVERLAY: ${{ inputs.overlay }}
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_PASSWORD: ${{ github.token }}
        run: |
          set -euo pipefail
          OVERLAY_DIR="deploy/k8s/overlays/${OVERLAY}"
          kubectl apply -f "${OVERLAY_DIR}/namespace.yaml"
          kubectl -n "$NS" create secret docker-registry ghcr-pull \
            --docker-server=ghcr.io \
            --docker-username="$GHCR_USERNAME" \
            --docker-password="$GHCR_PASSWORD" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Patch image tag and apply manifests
        env:
          NS: ${{ inputs.namespace }}
          OVERLAY: ${{ inputs.overlay }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          set -euo pipefail
          OVERLAY_DIR="deploy/k8s/overlays/${OVERLAY}"
          TAG="${IMAGE_TAG:-}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_SHA}"
          fi
          sed -i "s|newTag: latest|newTag: ${TAG}|g" "$OVERLAY_DIR/kustomization.yaml"
          sed -i "s|newTag: staging-latest|newTag: ${TAG}|g" "$OVERLAY_DIR/kustomization.yaml"
          kustomize build "$OVERLAY_DIR" | kubectl apply -f -
          kubectl -n "$NS" rollout status deployment/erpx-mock-api --timeout=300s
          kubectl -n "$NS" rollout status deployment/agent-service --timeout=300s
          kubectl -n "$NS" rollout status deployment/agent-worker-io --timeout=300s || true
          kubectl -n "$NS" rollout status deployment/agent-worker-ocr --timeout=300s || true
          kubectl -n "$NS" rollout status deployment/agent-worker-export --timeout=300s || true
          kubectl -n "$NS" rollout status deployment/agent-scheduler --timeout=300s
          kubectl -n "$NS" rollout status deployment/ui --timeout=300s

      - name: Smoke health check
        env:
          NS: ${{ inputs.namespace }}
          AGENT_API_KEY: ${{ secrets.PROD_AGENT_API_KEY != '' && secrets.PROD_AGENT_API_KEY || secrets.STAGING_AGENT_API_KEY }}
        run: |
          set -euo pipefail
          kubectl -n "$NS" port-forward svc/agent-service 8000:8000 >/tmp/pf-agent-prod.log 2>&1 &
          PF_AGENT=$!
          cleanup() {
            kill "$PF_AGENT" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT
          sleep 3
          if [ -n "${AGENT_API_KEY:-}" ]; then
            curl -fsS -H "X-API-Key: ${AGENT_API_KEY}" "http://127.0.0.1:8000/healthz" >/tmp/prod-healthz.json
          else
            curl -fsS "http://127.0.0.1:8000/healthz" >/tmp/prod-healthz.json
          fi
          cat /tmp/prod-healthz.json

      - name: Upload deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-prod-logs
          path: |
            /tmp/pf-agent-prod.log
            /tmp/prod-healthz.json
          retention-days: 14
