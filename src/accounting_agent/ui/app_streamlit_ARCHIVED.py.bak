from __future__ import annotations

import contextlib
import os
import re
import time
from datetime import date
from typing import Any

import boto3
import pandas as pd
import requests
import streamlit as st

AGENT_BASE_URL = os.getenv("UI_AGENT_BASE_URL", "http://localhost:8000").rstrip("/")
AGENT_API_KEY = os.getenv("AGENT_API_KEY", "")
DEBUG_UI = os.getenv("DEBUG_UI", "").lower() in ("1", "true", "yes")

MINIO_ENDPOINT = os.getenv("UI_MINIO_ENDPOINT", "http://localhost:9000")
MINIO_ACCESS_KEY = os.getenv("UI_MINIO_ACCESS_KEY", "minioadmin")
MINIO_SECRET_KEY = os.getenv("UI_MINIO_SECRET_KEY", "minioadmin")
MINIO_BUCKET_DROP = os.getenv("UI_MINIO_BUCKET_DROP", os.getenv("MINIO_BUCKET_DROP", "agent-drop"))

# Auto-refresh interval (seconds) ‚Äî set to 0 to disable
_AUTO_REFRESH_SECONDS = int(os.getenv("UI_AUTO_REFRESH_SECONDS", "15"))

# ---------------------------------------------------------------------------
# Vietnamese labels for run_types
# ---------------------------------------------------------------------------
_RUN_TYPE_LABELS: dict[str, str] = {
    "journal_suggestion": "ƒê·ªÅ xu·∫•t b√∫t to√°n",
    "bank_reconcile": "ƒê·ªëi chi·∫øu ng√¢n h√†ng",
    "cashflow_forecast": "D·ª± b√°o d√≤ng ti·ªÅn",
    "voucher_ingest": "Nh·∫≠p ch·ª©ng t·ª´",
    "voucher_classify": "Ph√¢n lo·∫°i ch·ª©ng t·ª´",
    "tax_export": "Xu·∫•t b√°o c√°o thu·∫ø",
    "working_papers": "B·∫£ng t√≠nh ki·ªÉm to√°n",
    "soft_checks": "Ki·ªÉm tra logic",
    "ar_dunning": "Nh·∫Øc n·ª£ c√¥ng n·ª£",
    "close_checklist": "Danh m·ª•c k·∫øt k·ª≥",
    "evidence_pack": "G√≥i b·∫±ng ch·ª©ng",
    "kb_index": "C·∫≠p nh·∫≠t kho tri th·ª©c",
    "contract_obligation": "Nghƒ©a v·ª• h·ª£p ƒë·ªìng",
}

_RUN_TYPE_ORDER = list(_RUN_TYPE_LABELS.keys())

# Status labels in Vietnamese
_STATUS_LABELS: dict[str, str] = {
    "queued": "‚è≥ ƒêang ch·ªù",
    "running": "üîÑ ƒêang ch·∫°y",
    "completed": "‚úÖ Ho√†n th√†nh",
    "failed": "‚ùå Th·∫•t b·∫°i",
    "pending": "‚è≥ Ch·ªù duy·ªát",
    "approved": "‚úÖ ƒê√£ duy·ªát",
    "rejected": "‚ùå ƒê√£ t·ª´ ch·ªëi",
    "open": "üîµ Ch∆∞a x·ª≠ l√Ω",
    "resolved": "‚úÖ ƒê√£ x·ª≠ l√Ω",
    "ignored": "‚è≠Ô∏è B·ªè qua",
}

# Severity labels in Vietnamese
_SEVERITY_LABELS: dict[str, str] = {
    "critical": "üî¥ Nghi√™m tr·ªçng",
    "high": "üü† Cao",
    "medium": "üü° Trung b√¨nh",
    "low": "üü¢ Th·∫•p",
    "error": "üî¥ L·ªói",
    "warning": "üü° C·∫£nh b√°o",
    "info": "üîµ Th√¥ng tin",
}

# P0 security: current_user_id from env, not editable by user
_DEMO_USER_ID = os.getenv("OPENCLAW_DEMO_USER_ID", "demo-checker")


def _headers() -> dict[str, str]:
    h: dict[str, str] = {}
    if AGENT_API_KEY:
        h["X-API-Key"] = AGENT_API_KEY
    return h


def _get(path: str, params: dict[str, Any] | None = None) -> Any:
    try:
        r = requests.get(f"{AGENT_BASE_URL}{path}", params=params, headers=_headers(), timeout=10)
        r.raise_for_status()
        return r.json()
    except requests.exceptions.HTTPError as e:
        detail = ""
        with contextlib.suppress(Exception):
            detail = e.response.json().get("detail", "")
        raise RuntimeError(detail or f"L·ªói {e.response.status_code} khi t·∫£i d·ªØ li·ªáu.") from e
    except requests.exceptions.ConnectionError as e:
        raise RuntimeError("Kh√¥ng th·ªÉ k·∫øt n·ªëi API backend. Vui l√≤ng ki·ªÉm tra h·ªá th·ªëng.") from e
    except requests.exceptions.Timeout as e:
        raise RuntimeError("API backend ph·∫£n h·ªìi qu√° ch·∫≠m (timeout). Th·ª≠ l·∫°i sau.") from e


def _post(path: str, json_body: dict[str, Any], idem: str | None = None) -> Any:
    headers = {"Content-Type": "application/json", **_headers()}
    if idem:
        headers["Idempotency-Key"] = idem
    try:
        r = requests.post(f"{AGENT_BASE_URL}{path}", json=json_body, headers=headers, timeout=10)
        r.raise_for_status()
        return r.json()
    except requests.exceptions.HTTPError as e:
        detail = ""
        with contextlib.suppress(Exception):
            detail = e.response.json().get("detail", "")
        raise RuntimeError(detail or f"L·ªói {e.response.status_code} khi g·ª≠i y√™u c·∫ßu.") from e
    except requests.exceptions.ConnectionError as e:
        raise RuntimeError("Kh√¥ng th·ªÉ k·∫øt n·ªëi API backend. Vui l√≤ng ki·ªÉm tra h·ªá th·ªëng.") from e
    except requests.exceptions.Timeout as e:
        raise RuntimeError("API backend ph·∫£n h·ªìi qu√° ch·∫≠m (timeout). Th·ª≠ l·∫°i sau.") from e


def _s3():
    return boto3.client(
        "s3",
        endpoint_url=MINIO_ENDPOINT,
        aws_access_key_id=MINIO_ACCESS_KEY,
        aws_secret_access_key=MINIO_SECRET_KEY,
        region_name=os.getenv("MINIO_REGION", "sgp1"),
    )


def _validate_period(period: str) -> bool:
    """Validate period format YYYY-MM."""
    return bool(re.match(r"^\d{4}-(0[1-9]|1[0-2])$", period.strip()))


def _action_guard(key: str) -> bool:
    """Double-click guard: returns True if action was already done."""
    return bool(st.session_state.get(f"_guard_{key}"))


def _mark_done(key: str) -> None:
    """Mark action as done for double-click guard."""
    st.session_state[f"_guard_{key}"] = True


# ---------------------------------------------------------------------------
# Page config
# ---------------------------------------------------------------------------
st.set_page_config(page_title="ERP AI K·∫ø to√°n ‚Äì Accounting Agent Layer", layout="wide")

# CSS: DataFrame toolbar fix + agent-feel styling + hex icon
st.markdown(
    """
    <style>
    [data-testid="stDataFrame"] [data-testid="stElementToolbar"] {
        z-index: 100 !important;
        pointer-events: auto !important;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .agent-status { animation: pulse 2s infinite; }
    /* Hexagon agent icon ‚Äî top-right corner */
    .hex-badge {
        position: fixed; top: 12px; right: 18px; z-index: 9999;
        width: 50px; height: 50px; cursor: pointer;
        background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
        clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 22px; font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: transform 0.2s ease;
    }
    .hex-badge:hover { transform: scale(1.15); }
    .timeline-step { border-left: 3px solid #1a73e8; padding: 4px 0 4px 14px; margin-left: 14px; }
    .timeline-step.completed { border-color: #34a853; }
    .timeline-step.failed { border-color: #ea4335; }
    .timeline-step.running { border-color: #fbbc04; }
    </style>
    <!-- Hexagonal Agent Icon ‚Äî click scrolls to Agent Command Center tab -->
    <div class="hex-badge" title="Trung t√¢m ƒëi·ªÅu khi·ªÉn Agent">ü§ñ</div>
    """,
    unsafe_allow_html=True,
)

st.title("ü§ñ ERP AI K·∫ø to√°n ‚Äî Agent")
st.caption("Accounting Agent Layer ‚Äî Tr·ª£ l√Ω k·∫ø to√°n th√¥ng minh t·ª± h√†nh (ch·ªâ ƒë·ªçc ‚Äî kh√¥ng ghi v√†o ERP g·ªëc)")
if DEBUG_UI:
    with st.expander("‚öôÔ∏è Ph√°t tri·ªÉn / G·ª° l·ªói", expanded=False):
        st.caption(f"Agent API: {AGENT_BASE_URL}")

# Auto-refresh state
if _AUTO_REFRESH_SECONDS > 0:
    _auto_key = "_last_auto_refresh"
    _now = time.time()
    _last = st.session_state.get(_auto_key, 0.0)
    if _now - _last >= _AUTO_REFRESH_SECONDS:
        st.session_state[_auto_key] = _now
        st.rerun()

current_user = _DEMO_USER_ID

# ---------------------------------------------------------------------------
# Tabs
# ---------------------------------------------------------------------------
(
    tab_agent,
    tab_trigger,
    tab_runs,
    tab_journal,
    tab_anomaly,
    tab_check,
    tab_cashflow,
    tab_voucher,
    tab_qna,
    tab_contract,
    tab_command_center,
) = st.tabs([
    "ü§ñ Trung t√¢m ƒëi·ªÅu khi·ªÉn",
    "üìã T·∫°o t√°c v·ª•",
    "üìÇ Qu·∫£n l√Ω t√°c v·ª•",
    "üßæ B√∫t to√°n ƒë·ªÅ xu·∫•t",
    "üîç Giao d·ªãch b·∫•t th∆∞·ªùng",
    "üìä Ki·ªÉm tra & B√°o c√°o",
    "üí∞ D√≤ng ti·ªÅn",
    "üì• Ch·ª©ng t·ª´",
    "üí¨ H·ªèi ƒë√°p",
    "üî¨ H·ª£p ƒë·ªìng (Th·ª≠ nghi·ªám)",
    "üéõÔ∏è Command Center (VN Agent)",
])


# ===== TAB 0: Trung t√¢m ƒëi·ªÅu khi·ªÉn Agent ==============================
with tab_agent:
    st.subheader("ü§ñ Trung t√¢m ƒëi·ªÅu khi·ªÉn Agent")
    st.markdown(
        "**ƒêi·ªÅu khi·ªÉn Agent b·∫±ng m·ª•c ti√™u** ‚Äî nh·∫≠p l·ªánh ti·∫øng Vi·ªát, "
        "Agent t·ª± ƒëi·ªÅu ph·ªëi chu·ªói t√°c v·ª• ph√π h·ª£p."
    )
    # Agent status badge
    st.markdown(
        '<span style="background:#34a853;color:#fff;padding:2px 10px;'
        'border-radius:12px;font-size:0.85em;">‚óè Tr·ª±c tuy·∫øn</span> '
        '<span style="color:#999;font-size:0.8em;">v1.0 ‚Äî 10 nh√≥m nghi·ªáp v·ª•</span>',
        unsafe_allow_html=True,
    )
    st.markdown("")

    # --- Goal-centric command input (CLI-style) ---
    col_cmd, col_period = st.columns([3, 1])
    with col_cmd:
        agent_command = st.text_input(
            "üéØ Nh·∫≠p l·ªánh cho Agent",
            value="",
            placeholder='V√≠ d·ª•: "ƒê√≥ng s·ªï th√°ng 1/2026" ho·∫∑c "Ki·ªÉm tra k·ª≥ 2026-01"',
            key="agent_cmd_input",
        )
    with col_period:
        agent_period = st.text_input(
            "K·ª≥ (YYYY-MM)",
            value=date.today().strftime("%Y-%m"),
            key="agent_cmd_period",
        )

    # Available goals ‚Äî CLI-style skill list
    with st.expander("üìã C√°c l·ªánh m√† Agent hi·ªÉu (nh·∫•n ƒë·ªÉ xem)", expanded=False):
        st.markdown("""
| L·ªánh | Chu·ªói t√°c v·ª• Agent s·∫Ω th·ª±c hi·ªán | S·ªë b∆∞·ªõc |
|---|---|---|
| **ƒê√≥ng s·ªï th√°ng X** | Nh·∫≠p CT ‚Üí Ph√¢n lo·∫°i ‚Üí B√∫t to√°n ‚Üí ƒê·ªëi chi·∫øu ‚Üí Ki·ªÉm tra ‚Üí Thu·∫ø ‚Üí D√≤ng ti·ªÅn | 7 |
| **Ki·ªÉm tra k·ª≥ X** | Nh·∫≠p CT ‚Üí Ph√¢n lo·∫°i ‚Üí Ki·ªÉm tra logic | 3 |
| **ƒê·ªëi chi·∫øu ng√¢n h√†ng** | ƒê·ªëi chi·∫øu NH ‚Üí Ki·ªÉm tra logic | 2 |
| **B√°o c√°o thu·∫ø th√°ng X** | Nh·∫≠p CT ‚Üí Ph√¢n lo·∫°i ‚Üí B√∫t to√°n ‚Üí Xu·∫•t b√°o c√°o thu·∫ø | 4 |
| **Nh·∫≠p ch·ª©ng t·ª´** | Nh·∫≠p CT ‚Üí Ph√¢n lo·∫°i | 2 |
| **D·ª± b√°o d√≤ng ti·ªÅn** | D·ª± b√°o d√≤ng ti·ªÅn | 1 |
| **Ph√°t hi·ªán b·∫•t th∆∞·ªùng** | Ki·ªÉm tra logic ‚Üí Ph√°t hi·ªán anomaly | 2 |
| **R√† so√°t h·ª£p ƒë·ªìng** | Nghƒ©a v·ª• h·ª£p ƒë·ªìng | 1 |

> üí° **M·∫πo:** B·∫°n c√≥ th·ªÉ nh·∫≠p l·ªánh t·ª± do ‚Äî Agent s·∫Ω c·ªë g·∫Øng hi·ªÉu v√† ch·ªçn chu·ªói t√°c v·ª• ph√π h·ª£p nh·∫•t.
        """)

    if st.button("üöÄ G·ª≠i l·ªánh cho Agent", key="agent_cmd_go", type="primary"):
        if not agent_command.strip():
            st.warning("‚ö†Ô∏è Vui l√≤ng nh·∫≠p l·ªánh cho Agent.")
        elif agent_period.strip() and not _validate_period(agent_period.strip()):
            st.error("‚ùå K·ª≥ k·∫ø to√°n kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Vui l√≤ng nh·∫≠p theo YYYY-MM (v√≠ d·ª•: 2026-01).")
        else:
            with st.spinner("ü§ñ Agent ƒëang ph√¢n t√≠ch l·ªánh v√† ƒëi·ªÅu ph·ªëi t√°c v·ª•‚Ä¶"):
                try:
                    cmd_res = _post(
                        "/agent/v1/agent/commands",
                        {
                            "command": agent_command.strip(),
                            "period": agent_period.strip() or None,
                        },
                    )
                    if cmd_res.get("status") == "no_chain":
                        st.warning(
                            f"‚ö†Ô∏è {cmd_res.get('message', 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c m·ª•c ti√™u.')}\n\n"
                            f"**G·ª£i √Ω:** {', '.join(cmd_res.get('available_goals', []))}"
                        )
                    else:
                        runs = cmd_res.get("runs", [])
                        chain = cmd_res.get("chain", [])
                        st.success(
                            f"‚úÖ Agent ƒë√£ ti·∫øp nh·∫≠n l·ªánh: **{cmd_res.get('goal_label', '')}**\n\n"
                            f"üìä Chu·ªói t√°c v·ª•: {len(chain)} b∆∞·ªõc  ‚Ä¢  "
                            f"T√°c v·ª• t·∫°o m·ªõi: {sum(1 for r in runs if not r.get('reused'))}"
                        )
                        for r in runs:
                            icon = "‚ôªÔ∏è" if r.get("reused") else "üÜï"
                            st.caption(
                                f"  {icon} {_RUN_TYPE_LABELS.get(r['run_type'], r['run_type'])} "
                                f"‚Äî `{r['run_id'][:12]}‚Ä¶` [{_STATUS_LABELS.get(r['status'], r['status'])}]"
                            )
                        time.sleep(0.5)
                        st.rerun()
                except Exception as e:
                    st.error(f"‚ùå L·ªói g·ª≠i l·ªánh: {e}")

    st.divider()

    # --- Activity Timeline ---
    st.subheader("üìú D√≤ng th·ªùi gian ho·∫°t ƒë·ªông Agent")
    col_tl_hdr, col_tl_ref = st.columns([3, 1])
    with col_tl_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_timeline"):
            st.rerun()

    try:
        timeline = _get("/agent/v1/agent/timeline", params={"limit": 30})
        tl_items = timeline.get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i d√≤ng th·ªùi gian: {e}")
        tl_items = []

    if tl_items:
        for item in tl_items:
            icon = item.get("icon", "‚ùì")
            title = item.get("title", "")
            detail = item.get("detail", "")
            ts = item.get("ts", "")[:19]
            item_type = item.get("type", "run")
            status = item.get("status", "")

            css_class = "completed" if status == "completed" else (
                "failed" if status == "failed" else (
                    "running" if status == "running" else ""
                )
            )

            if item_type == "run":
                st.markdown(
                    f'<div class="timeline-step {css_class}">'
                    f"<strong>{icon} {title}</strong><br/>"
                    f"<small>üïê {ts} ‚Äî {detail}</small></div>",
                    unsafe_allow_html=True,
                )
            else:
                st.markdown(
                    f'<div class="timeline-step {css_class}" style="margin-left: 30px;">'
                    f"{icon} {title}<br/>"
                    f"<small>{detail}</small></div>",
                    unsafe_allow_html=True,
                )
    else:
        st.info(
            "Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o. G·ª≠i l·ªánh cho Agent ·ªü tr√™n ho·∫∑c "
            "t·∫°o t√°c v·ª• ·ªü tab **üìã T·∫°o t√°c v·ª•** ƒë·ªÉ b·∫Øt ƒë·∫ßu!"
        )


# ===== TAB 1: T·∫°o t√°c v·ª• =============================================
with tab_trigger:
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("T·∫°o t√°c v·ª• th·ªß c√¥ng")
        requested_by = st.text_input("Ng∆∞·ªùi y√™u c·∫ßu (t√πy ch·ªçn)", value="", key="trig_user")
        run_type = st.selectbox(
            "Lo·∫°i t√°c v·ª•",
            _RUN_TYPE_ORDER,
            format_func=lambda rt: _RUN_TYPE_LABELS.get(rt, rt),
            key="trig_rt",
        )
        payload: dict[str, Any] = {}
        # Period required for these run types (must match backend _PERIOD_REQUIRED_RUN_TYPES)
        _period_required = run_type in {
            "voucher_ingest", "soft_checks", "journal_suggestion",
            "cashflow_forecast", "tax_export", "bank_reconcile",
            "working_papers", "close_checklist",
        }
        if run_type in {"tax_export", "working_papers", "close_checklist"}:
            payload["period"] = st.text_input(
                "K·ª≥ k·∫ø to√°n (YYYY-MM) *", value=date.today().strftime("%Y-%m"), key="trig_period",
            )
        if run_type == "soft_checks":
            payload["updated_after"] = st.text_input("C·∫≠p nh·∫≠t sau (ISO)", value="", key="trig_ua")
            payload["period"] = st.text_input(
                "K·ª≥ k·∫ø to√°n (YYYY-MM) *", value=date.today().strftime("%Y-%m"), key="trig_sc_period",
            )
        if run_type == "cashflow_forecast":
            payload["period"] = st.text_input(
                "K·ª≥ (YYYY-MM) *", value=date.today().strftime("%Y-%m"), key="trig_cf_period",
            )
            payload["horizon_days"] = st.number_input("S·ªë ng√†y d·ª± b√°o", min_value=7, max_value=90, value=30)
        if run_type == "voucher_ingest":
            payload["period"] = st.text_input(
                "K·ª≥ k·∫ø to√°n (YYYY-MM) *", value=date.today().strftime("%Y-%m"), key="trig_vi_period",
            )
            payload["source"] = st.selectbox("Ngu·ªìn d·ªØ li·ªáu", ["vn_fixtures", "payload", "erpx_mock"])
        if run_type == "journal_suggestion":
            payload["period"] = st.text_input(
                "K·ª≥ k·∫ø to√°n (YYYY-MM) *", value=date.today().strftime("%Y-%m"), key="trig_js_period",
            )
        if run_type == "bank_reconcile":
            payload["period"] = st.text_input(
                "K·ª≥ k·∫ø to√°n (YYYY-MM) *", value=date.today().strftime("%Y-%m"), key="trig_br_period",
            )
        if run_type == "voucher_classify":
            payload["period"] = st.text_input("K·ª≥ (YYYY-MM, t√πy ch·ªçn)", value="", key="trig_vc_period")
        if run_type == "ar_dunning":
            payload["as_of"] = st.text_input("Ng√†y c·∫Øt (YYYY-MM-DD)", value=date.today().isoformat())
        if run_type == "evidence_pack":
            payload["exception_id"] = st.text_input("M√£ ngo·∫°i l·ªá (exception_id)", value="")
            payload["issue_id"] = st.text_input("M√£ v·∫•n ƒë·ªÅ (t√πy ch·ªçn)", value="")
        if run_type == "kb_index":
            payload["file_uri"] = st.text_input("ƒê∆∞·ªùng d·∫´n file", value="")
            payload["title"] = st.text_input("Ti√™u ƒë·ªÅ (t√πy ch·ªçn)", value="")
            payload["doc_type"] = st.selectbox("Lo·∫°i t√†i li·ªáu", ["process", "law", "template"])
            payload["version"] = st.text_input("Phi√™n b·∫£n", value="v1")
        if run_type == "contract_obligation":
            payload["case_key"] = st.text_input("M√£ h·ª£p ƒë·ªìng (case_key, t√πy ch·ªçn)", value="")
            payload["partner_name"] = st.text_input("T√™n ƒë·ªëi t√°c (t√πy ch·ªçn)", value="")
            payload["partner_tax_id"] = st.text_input("MST ƒë·ªëi t√°c (t√πy ch·ªçn)", value="")
            payload["contract_code"] = st.text_input("M√£ h·ª£p ƒë·ªìng (t√πy ch·ªçn)", value="")
            payload["contract_files"] = [
                x.strip()
                for x in st.text_area("Danh s√°ch file h·ª£p ƒë·ªìng (m·ªói d√≤ng m·ªôt file)").splitlines()
                if x.strip()
            ]
            payload["email_files"] = [
                x.strip()
                for x in st.text_area("Danh s√°ch file email (m·ªói d√≤ng m·ªôt file)").splitlines()
                if x.strip()
            ]

        idem = st.text_input("Kh√≥a duy nh·∫•t (Idempotency-Key, t√πy ch·ªçn)", value="", key="trig_idem")

        if st.button("‚ñ∂Ô∏è Ch·∫°y t√°c v·ª•", key="trig_run"):
            _p = (payload.get("period") or "").strip()
            if _period_required and not _p:
                st.error("‚ùå Vui l√≤ng nh·∫≠p k·ª≥ k·∫ø to√°n (period) ‚Äî tr∆∞·ªùng b·∫Øt bu·ªôc cho lo·∫°i t√°c v·ª• n√†y.")
            elif _p and not _validate_period(_p):
                st.error("‚ùå K·ª≥ k·∫ø to√°n kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Vui l√≤ng nh·∫≠p theo YYYY-MM (v√≠ d·ª•: 2026-01).")
            else:
                body: dict[str, Any] = {"run_type": run_type, "trigger_type": "manual", "payload": payload}
                if requested_by.strip():
                    body["requested_by"] = requested_by.strip()
                try:
                    res = _post("/agent/v1/runs", body, idem or None)
                    _task_preview = res.get("tasks", [])
                    _steps_text = ""
                    if _task_preview:
                        _steps_text = "\n\nChu·ªói x·ª≠ l√Ω: " + " ‚Üí ".join(
                            t.get("task_name", "?") for t in _task_preview
                        )
                    _period_info = ""
                    _p_val = payload.get("period", "")
                    if _p_val:
                        _period_info = f"  ‚Ä¢  K·ª≥: `{_p_val}`"
                    st.success(
                        f"‚úÖ T√°c v·ª• **{_RUN_TYPE_LABELS.get(run_type, run_type)}** ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!\n\n"
                        f"- **M√£ t√°c v·ª•:** `{res.get('run_id', '')}`\n"
                        f"- **Lo·∫°i:** {_RUN_TYPE_LABELS.get(run_type, run_type)}\n"
                        f"- **Tr·∫°ng th√°i:** {_STATUS_LABELS.get(res.get('status', ''), res.get('status', ''))}"
                        f"{_period_info}"
                        f"{_steps_text}\n\n"
                        f"üëâ Xem chi ti·∫øt t·∫°i tab **Qu·∫£n l√Ω t√°c v·ª•**."
                    )
                    time.sleep(0.5)
                    st.rerun()
                except Exception as e:
                    st.error(f"‚ùå Kh√¥ng th·ªÉ t·∫°o t√°c v·ª•: {e}")

    with col2:
        st.subheader("T·∫£i file l√™n (K√≠ch ho·∫°t s·ª± ki·ªán)")
        mode = st.selectbox(
            "Lo·∫°i file", ["attachments", "kb"], key="drop_mode",
            format_func=lambda m: "Ch·ª©ng t·ª´ ƒë√≠nh k√®m" if m == "attachments" else "T√†i li·ªáu tri th·ª©c",
        )
        up = st.file_uploader("Ch·ªçn file", type=None, key="drop_file")
        if up is not None and st.button("üì§ T·∫£i l√™n", key="drop_upload"):
            key = f"drop/{mode}/{int(time.time())}_{up.name}"
            s3 = _s3()
            s3.put_object(Bucket=MINIO_BUCKET_DROP, Key=key, Body=up.getvalue())
            st.success(f"‚úÖ ƒê√£ t·∫£i l√™n th√†nh c√¥ng: **{up.name}**")


# ===== TAB 2: Qu·∫£n l√Ω t√°c v·ª• ===========================================
with tab_runs:
    col_runs_hdr, col_refresh = st.columns([3, 1])
    with col_runs_hdr:
        st.subheader("Danh s√°ch t√°c v·ª•")
    with col_refresh:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_runs"):
            st.rerun()

    col_flt_rt, col_flt_st = st.columns(2)
    with col_flt_rt:
        _filter_rt = st.selectbox(
            "L·ªçc lo·∫°i t√°c v·ª•",
            ["(t·∫•t c·∫£)"] + _RUN_TYPE_ORDER,
            format_func=lambda rt: _RUN_TYPE_LABELS.get(rt, rt) if rt != "(t·∫•t c·∫£)" else "(T·∫•t c·∫£)",
            key="run_flt_rt",
        )
    with col_flt_st:
        _filter_st = st.selectbox(
            "L·ªçc tr·∫°ng th√°i",
            ["(t·∫•t c·∫£)", "queued", "running", "completed", "failed"],
            format_func=lambda s: _STATUS_LABELS.get(s, s) if s != "(t·∫•t c·∫£)" else "(T·∫•t c·∫£)",
            key="run_flt_st",
        )

    try:
        _rp: dict[str, Any] = {"limit": 50}
        if _filter_rt != "(t·∫•t c·∫£)":
            _rp["run_type"] = _filter_rt
        if _filter_st != "(t·∫•t c·∫£)":
            _rp["status"] = _filter_st
        runs = _get("/agent/v1/runs", params=_rp).get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i danh s√°ch t√°c v·ª•: {e}")
        runs = []
    if runs:
        df = pd.DataFrame(runs)
        df["Lo·∫°i t√°c v·ª•"] = df["run_type"].map(lambda rt: _RUN_TYPE_LABELS.get(rt, rt))
        df["Tr·∫°ng th√°i"] = df["status"].map(lambda s: _STATUS_LABELS.get(s, s))
        st.dataframe(
            df[["run_id", "Lo·∫°i t√°c v·ª•", "Tr·∫°ng th√°i", "trigger_type", "created_at"]],
            use_container_width=True,
            column_config={
                "run_id": "M√£ t√°c v·ª•",
                "trigger_type": "Ngu·ªìn k√≠ch ho·∫°t",
                "created_at": "Th·ªùi gian t·∫°o",
            },
        )
        run_id = st.text_input("M√£ t√°c v·ª• xem chi ti·∫øt", value=df.iloc[0]["run_id"], key="runs_inspect")

        if run_id:
            # Fetch full run detail (with tasks) for chain trace
            try:
                _run_detail = _get(f"/agent/v1/runs/{run_id}")
            except Exception:
                _run_detail = {}

            # Show run summary with timing
            if _run_detail:
                with st.expander("üìå Th√¥ng tin t√°c v·ª•", expanded=True):
                    _rd_cols = st.columns(3)
                    with _rd_cols[0]:
                        st.markdown(f"**Lo·∫°i:** {_RUN_TYPE_LABELS.get(_run_detail.get('run_type', ''), _run_detail.get('run_type', ''))}")
                        st.markdown(f"**Tr·∫°ng th√°i:** {_STATUS_LABELS.get(_run_detail.get('status', ''), _run_detail.get('status', ''))}")
                    with _rd_cols[1]:
                        st.markdown(f"**T·∫°o l√∫c:** {str(_run_detail.get('created_at', ''))[:19]}")
                        _started = _run_detail.get("started_at")
                        _finished = _run_detail.get("finished_at")
                        if _started:
                            st.markdown(f"**B·∫Øt ƒë·∫ßu:** {str(_started)[:19]}")
                        if _finished:
                            st.markdown(f"**Ho√†n th√†nh:** {str(_finished)[:19]}")
                    with _rd_cols[2]:
                        _cursor_in = _run_detail.get("cursor_in") or {}
                        if isinstance(_cursor_in, dict) and _cursor_in:
                            _ci_parts = [f"{k}: {v}" for k, v in _cursor_in.items() if v]
                            st.markdown(f"**Tham s·ªë:** {', '.join(_ci_parts[:3])}")
                        _stats = _run_detail.get("stats") or {}
                        if isinstance(_stats, dict) and _stats:
                            _st_parts = [f"{k}: {v}" for k, v in _stats.items()]
                            st.markdown(f"**K·∫øt qu·∫£:** {', '.join(_st_parts[:4])}")

            colA, colB = st.columns(2)
            with colA:
                st.markdown("### Chu·ªói x·ª≠ l√Ω (Chain Trace)")
                try:
                    tasks = _get("/agent/v1/tasks", params={"run_id": run_id}).get("items", [])
                except Exception as e:
                    st.error(f"L·ªói t·∫£i b∆∞·ªõc x·ª≠ l√Ω: {e}")
                    tasks = []
                if tasks:
                    df_t = pd.DataFrame(tasks)
                    df_t["Tr·∫°ng th√°i"] = df_t["status"].map(lambda s: _STATUS_LABELS.get(s, s))
                    # Add timing info
                    _show_cols = ["task_name", "Tr·∫°ng th√°i", "started_at", "finished_at", "error"]
                    _avail_cols = [c for c in _show_cols if c in df_t.columns]
                    st.dataframe(
                        df_t[_avail_cols],
                        use_container_width=True,
                        column_config={
                            "task_name": "B∆∞·ªõc",
                            "error": "L·ªói",
                            "started_at": "B·∫Øt ƒë·∫ßu",
                            "finished_at": "Ho√†n th√†nh",
                        },
                    )
                else:
                    st.info("Ch∆∞a c√≥ b∆∞·ªõc x·ª≠ l√Ω cho t√°c v·ª• n√†y.")

                # --- Downstream artifact linkage ---
                _run_rt = _run_detail.get("run_type", "") if _run_detail else ""
                _run_period = ""
                if _run_detail:
                    _ci = _run_detail.get("cursor_in") or {}
                    if isinstance(_ci, dict):
                        _run_period = _ci.get("period", "")

                if _run_rt == "soft_checks" and run_id:
                    st.markdown("#### üîó K·∫øt qu·∫£ downstream")
                    try:
                        _sc_params: dict[str, Any] = {"limit": 10}
                        _sc_results = _get("/agent/v1/acct/soft_check_results", params=_sc_params).get("items", [])
                        _matched = [r for r in _sc_results if r.get("run_id") == run_id]
                        if _matched:
                            for _scr in _matched:
                                st.success(
                                    f"‚úÖ ƒê√£ t·∫°o **{_scr.get('total_checks', 0)}** ki·ªÉm tra "
                                    f"(score: {_scr.get('score', 0):.2%}, "
                                    f"warnings: {_scr.get('warnings', 0)}, "
                                    f"errors: {_scr.get('errors', 0)}) ‚Äî "
                                    f"K·ª≥: {_scr.get('period', '')}"
                                )
                        else:
                            st.info("Ch∆∞a c√≥ k·∫øt qu·∫£ soft_check li√™n k·∫øt v·ªõi run n√†y.")
                    except Exception:
                        pass
                elif _run_rt == "voucher_ingest" and _run_period:
                    st.markdown("#### üîó K·∫øt qu·∫£ downstream")
                    try:
                        _v_items = _get("/agent/v1/acct/vouchers", params={"limit": 5}).get("items", [])
                        _v_count = len(_v_items)
                        st.info(
                            f"üìã T·ªïng ch·ª©ng t·ª´ trong h·ªá th·ªëng: ‚â•{_v_count} b·∫£n ghi. "
                            f"Xem chi ti·∫øt t·∫°i tab **üì• Ch·ª©ng t·ª´**."
                        )
                    except Exception:
                        pass
                elif _run_rt == "tax_export":
                    st.markdown("#### üîó K·∫øt qu·∫£ downstream")
                    st.info("üìã B√°o c√°o thu·∫ø ƒë√£ xu·∫•t. Xem chi ti·∫øt t·∫°i tab **üìä Ki·ªÉm tra & B√°o c√°o**.")
            with colB:
                st.markdown("### Nh·∫≠t k√Ω ho·∫°t ƒë·ªông")
                try:
                    logs = _get("/agent/v1/logs", params={"run_id": run_id, "limit": 200}).get("items", [])
                except Exception as e:
                    st.error(f"L·ªói t·∫£i nh·∫≠t k√Ω: {e}")
                    logs = []
                if logs:
                    st.dataframe(
                        pd.DataFrame(logs)[["ts", "level", "message"]],
                        use_container_width=True,
                        column_config={
                            "ts": "Th·ªùi gian",
                            "level": "M·ª©c",
                            "message": "N·ªôi dung",
                        },
                    )
                else:
                    st.info("Ch∆∞a c√≥ nh·∫≠t k√Ω cho t√°c v·ª• n√†y.")
    else:
        st.info("Ch∆∞a c√≥ t√°c v·ª• n√†o. T·∫°o m·ªõi ·ªü tab **üìã T·∫°o t√°c v·ª•**.")


# ===== TAB 3: B√∫t to√°n ƒë·ªÅ xu·∫•t ========================================
with tab_journal:
    col_jp_hdr, col_jp_ref = st.columns([3, 1])
    with col_jp_hdr:
        st.subheader("üßæ B√∫t to√°n ƒë·ªÅ xu·∫•t")
    with col_jp_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_journal"):
            st.rerun()

    st.markdown(f"üë§ Ng∆∞·ªùi duy·ªát hi·ªán t·∫°i: **{current_user}**")

    try:
        proposals_data = _get("/agent/v1/acct/journal_proposals", params={"limit": 50})
        proposals_acct = proposals_data.get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i b√∫t to√°n ƒë·ªÅ xu·∫•t: {e}")
        proposals_acct = []

    if proposals_acct:
        for p in proposals_acct:
            lines_str = " | ".join(
                f"{'N·ª£' if ln.get('debit', 0) > 0 else 'C√≥'} TK {ln.get('account_code', '')} "
                f"({ln.get('account_name', '')}) {ln.get('debit', 0) or ln.get('credit', 0):,.0f}"
                for ln in p.get("lines", [])
            )
            status_icon = {"pending": "‚è≥", "approved": "‚úÖ", "rejected": "‚ùå"}.get(p.get("status", ""), "‚ùì")
            col_p1, col_p2 = st.columns([3, 1])
            with col_p1:
                st.markdown(
                    f"**{status_icon} {p.get('description', 'Kh√¥ng c√≥ m√¥ t·∫£')}** ‚Äî "
                    f"ƒê·ªô tin c·∫≠y: {p.get('confidence', 0):.0%}  \n"
                    f"üìù {lines_str}"
                )
            with col_p2:
                if p.get("status") == "pending":
                    _gk_a = f"jp_approve_{p['id']}"
                    _gk_r = f"jp_reject_{p['id']}"
                    if _action_guard(_gk_a) or _action_guard(_gk_r):
                        st.caption("‚úî ƒê√£ x·ª≠ l√Ω ‚Äî ƒëang l√†m m·ªõi‚Ä¶")
                    else:
                        col_a, col_r = st.columns(2)
                        with col_a:
                            if st.button("‚úÖ Duy·ªát", key=_gk_a):
                                try:
                                    _post(
                                        f"/agent/v1/acct/journal_proposals/{p['id']}/review",
                                        {"status": "approved", "reviewed_by": current_user},
                                    )
                                    _mark_done(_gk_a)
                                    st.success("‚úÖ ƒê√£ duy·ªát b√∫t to√°n")
                                    st.rerun()
                                except Exception as ex:
                                    st.error(f"‚ùå {ex}")
                        with col_r:
                            if st.button("‚ùå T·ª´ ch·ªëi", key=_gk_r):
                                try:
                                    _post(
                                        f"/agent/v1/acct/journal_proposals/{p['id']}/review",
                                        {"status": "rejected", "reviewed_by": current_user},
                                    )
                                    _mark_done(_gk_r)
                                    st.success("‚ùå ƒê√£ t·ª´ ch·ªëi b√∫t to√°n")
                                    st.rerun()
                                except Exception as ex:
                                    st.error(f"‚ùå {ex}")
                else:
                    st.caption(
                        f"{_STATUS_LABELS.get(p.get('status', ''), p.get('status', ''))} "
                        f"b·ªüi {p.get('reviewed_by', 'N/A')}"
                    )
    else:
        st.info("Ch∆∞a c√≥ b√∫t to√°n ƒë·ªÅ xu·∫•t. Ch·∫°y **ƒê·ªÅ xu·∫•t b√∫t to√°n** ·ªü tab T·∫°o t√°c v·ª•.")


# ===== TAB 4: Giao d·ªãch b·∫•t th∆∞·ªùng ====================================
with tab_anomaly:
    col_an_hdr, col_an_ref = st.columns([3, 1])
    with col_an_hdr:
        st.subheader("üîç Giao d·ªãch b·∫•t th∆∞·ªùng")
    with col_an_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_anomaly"):
            st.rerun()

    try:
        anomalies_data = _get("/agent/v1/acct/anomaly_flags", params={"limit": 50})
        anomalies = anomalies_data.get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i d·ªØ li·ªáu giao d·ªãch b·∫•t th∆∞·ªùng: {e}")
        anomalies = []

    if anomalies:
        df_anom = pd.DataFrame(anomalies)
        df_anom["M·ª©c ƒë·ªô"] = df_anom["severity"].map(
            lambda s: _SEVERITY_LABELS.get(s, f"‚ö™ {s}")
        )
        st.dataframe(
            df_anom[["M·ª©c ƒë·ªô", "anomaly_type", "description", "resolution", "created_at"]],
            use_container_width=True,
            column_config={
                "anomaly_type": "Lo·∫°i b·∫•t th∆∞·ªùng",
                "description": "M√¥ t·∫£",
                "resolution": "Tr·∫°ng th√°i",
                "created_at": "Th·ªùi gian",
            },
        )

        open_flags = [a for a in anomalies if a.get("resolution") == "open"]
        if open_flags:
            flag_id = st.selectbox(
                "Ch·ªçn giao d·ªãch b·∫•t th∆∞·ªùng c·∫ßn x·ª≠ l√Ω",
                [f["id"] for f in open_flags],
                format_func=lambda fid: next(
                    (f"{f['anomaly_type']}: {f['description'][:60]}..." for f in open_flags if f["id"] == fid),
                    fid,
                ),
                key="an_select",
            )
            _gk_res = f"an_resolve_{flag_id}"
            _gk_ign = f"an_ignore_{flag_id}"
            if _action_guard(_gk_res) or _action_guard(_gk_ign):
                st.caption("‚úî ƒê√£ x·ª≠ l√Ω ‚Äî ƒëang l√†m m·ªõi‚Ä¶")
            else:
                col_res, col_ign = st.columns(2)
                with col_res:
                    if st.button("‚úÖ ƒê√£ x·ª≠ l√Ω", key=_gk_res):
                        try:
                            _post(
                                f"/agent/v1/acct/anomaly_flags/{flag_id}/resolve",
                                {"resolution": "resolved", "resolved_by": current_user},
                            )
                            _mark_done(_gk_res)
                            st.success("‚úÖ ƒê√£ gi·∫£i quy·∫øt")
                            st.rerun()
                        except Exception as ex:
                            st.error(f"‚ùå {ex}")
                with col_ign:
                    if st.button("‚è≠Ô∏è B·ªè qua", key=_gk_ign):
                        try:
                            _post(
                                f"/agent/v1/acct/anomaly_flags/{flag_id}/resolve",
                                {"resolution": "ignored", "resolved_by": current_user},
                            )
                            _mark_done(_gk_ign)
                            st.success("‚è≠Ô∏è ƒê√£ b·ªè qua")
                            st.rerun()
                        except Exception as ex:
                            st.error(f"‚ùå {ex}")
        else:
            st.success("Kh√¥ng c√≥ giao d·ªãch b·∫•t th∆∞·ªùng ch∆∞a x·ª≠ l√Ω. üéâ")
    else:
        st.info("Ch∆∞a ph√°t hi·ªán giao d·ªãch b·∫•t th∆∞·ªùng. Ch·∫°y **ƒê·ªëi chi·∫øu ng√¢n h√†ng** ·ªü tab T·∫°o t√°c v·ª•.")


# ===== TAB 5: Ki·ªÉm tra & B√°o c√°o ======================================
with tab_check:
    col_ck_hdr, col_ck_ref = st.columns([3, 1])
    with col_ck_hdr:
        st.subheader("üìä Ki·ªÉm tra logic")
    with col_ck_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_check"):
            st.rerun()

    try:
        scr_data = _get("/agent/v1/acct/soft_check_results", params={"limit": 50})
        scr_items = scr_data.get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i k·∫øt qu·∫£ ki·ªÉm tra: {e}")
        scr_items = []

    if scr_items:
        df_scr = pd.DataFrame(scr_items)
        df_scr["ƒêi·ªÉm"] = df_scr["score"].map(
            lambda s: f"{'üü¢' if s >= 0.8 else 'üü°' if s >= 0.5 else 'üî¥'} {s:.0%}"
        )
        st.dataframe(
            df_scr[["period", "total_checks", "passed", "warnings", "errors", "ƒêi·ªÉm", "created_at"]],
            use_container_width=True,
            column_config={
                "period": "K·ª≥ k·∫ø to√°n",
                "total_checks": "T·ªïng ki·ªÉm tra",
                "passed": "ƒê·∫°t",
                "warnings": "C·∫£nh b√°o",
                "errors": "L·ªói",
                "created_at": "Th·ªùi gian",
            },
        )
    else:
        # P0: diagnostic info when runs complete but no results
        try:
            recent = _get("/agent/v1/runs", params={"run_type": "soft_checks", "limit": 1})
            ri = recent.get("items", [])
            if ri and ri[0].get("status") == "completed":
                st.info(
                    "T√°c v·ª• **Ki·ªÉm tra logic** ƒë√£ ch·∫°y xong nh∆∞ng kh√¥ng t·∫°o k·∫øt qu·∫£ ‚Äî "
                    "c√≥ th·ªÉ ch∆∞a c√≥ ch·ª©ng t·ª´ trong k·ª≥ ho·∫∑c d·ªØ li·ªáu mirror Acct* tr·ªëng.\n\n"
                    f"M√£ t√°c v·ª• g·∫ßn nh·∫•t: `{ri[0].get('run_id', '')[:12]}‚Ä¶`"
                )
            else:
                st.info("Ch∆∞a c√≥ k·∫øt qu·∫£ ki·ªÉm tra. Ch·∫°y **Ki·ªÉm tra logic** ·ªü tab T·∫°o t√°c v·ª• ƒë·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu.")
        except Exception:
            st.info("Ch∆∞a c√≥ k·∫øt qu·∫£ ki·ªÉm tra. Ch·∫°y **Ki·ªÉm tra logic** ·ªü tab T·∫°o t√°c v·ª• ƒë·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu.")

    with st.expander("üîé Chi ti·∫øt ‚Äî V·∫•n ƒë·ªÅ ph√°t hi·ªán", expanded=bool(scr_items)):
        issue_filter = st.selectbox(
            "L·ªçc tr·∫°ng th√°i",
            ["open", "resolved", "ignored", "(t·∫•t c·∫£)"],
            format_func=lambda s: _STATUS_LABELS.get(s, s) if s != "(t·∫•t c·∫£)" else "(T·∫•t c·∫£)",
            key="vi_filter",
        )
        try:
            vi_params: dict[str, Any] = {"limit": 50}
            if issue_filter != "(t·∫•t c·∫£)":
                vi_params["resolution"] = issue_filter
            vi_data = _get("/agent/v1/acct/validation_issues", params=vi_params)
            vi_items = vi_data.get("items", [])
        except Exception as e:
            st.error(f"L·ªói t·∫£i v·∫•n ƒë·ªÅ ki·ªÉm tra: {e}")
            vi_items = []

        if vi_items:
            df_vi = pd.DataFrame(vi_items)
            df_vi["M·ª©c ƒë·ªô"] = df_vi["severity"].map(
                lambda sv: _SEVERITY_LABELS.get(sv, f"‚ö™ {sv}")
            )
            st.dataframe(
                df_vi[["rule_code", "M·ª©c ƒë·ªô", "message", "erp_ref", "resolution", "created_at"]],
                use_container_width=True,
                column_config={
                    "rule_code": "M√£ quy t·∫Øc",
                    "message": "N·ªôi dung",
                    "erp_ref": "Tham chi·∫øu ERP",
                    "resolution": "Tr·∫°ng th√°i",
                    "created_at": "Th·ªùi gian",
                },
            )

            resolve_id = st.text_input("M√£ v·∫•n ƒë·ªÅ (Issue ID) ƒë·ªÉ x·ª≠ l√Ω", value="", key="resolve_vi_id")
            if resolve_id:
                _gk_vi = f"vi_resolve_{resolve_id}"
                if _action_guard(_gk_vi):
                    st.caption("‚úî ƒê√£ x·ª≠ l√Ω")
                elif st.button("‚úÖ ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω", key="resolve_vi_btn"):
                    try:
                        _post(
                            f"/agent/v1/acct/validation_issues/{resolve_id}/resolve",
                            {"action": "resolved", "resolved_by": current_user},
                        )
                        _mark_done(_gk_vi)
                        st.success("‚úÖ ƒê√£ ƒë√°nh d·∫•u x·ª≠ l√Ω")
                        st.rerun()
                    except Exception as ex:
                        st.error(f"‚ùå L·ªói: {ex}")
        else:
            st.info("Kh√¥ng c√≥ v·∫•n ƒë·ªÅ ki·ªÉm tra n√†o.")

    st.divider()
    st.subheader("üìà B√°o c√°o k·∫ø to√°n")

    try:
        rpt_data = _get("/agent/v1/acct/report_snapshots", params={"limit": 20})
        rpt_items = rpt_data.get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i b√°o c√°o: {e}")
        rpt_items = []

    if rpt_items:
        df_rpt = pd.DataFrame(rpt_items)
        display_rpt_cols = ["report_type", "period", "version", "created_at"]
        available_rpt = [c for c in display_rpt_cols if c in df_rpt.columns]
        st.dataframe(
            df_rpt[available_rpt],
            use_container_width=True,
            column_config={
                "report_type": "Lo·∫°i b√°o c√°o",
                "period": "K·ª≥",
                "version": "Phi√™n b·∫£n",
                "created_at": "Th·ªùi gian",
            },
        )
        with st.expander("üìã Chi ti·∫øt b√°o c√°o m·ªõi nh·∫•t"):
            latest = rpt_items[0]
            if latest.get("summary_json"):
                st.json(latest["summary_json"])
            if latest.get("has_file"):
                st.caption("üìé C√≥ t·ªáp b√°o c√°o ƒë√≠nh k√®m")
    else:
        # P0: diagnostic info when tax_export runs complete but no results
        try:
            recent_rpt = _get("/agent/v1/runs", params={"run_type": "tax_export", "limit": 1})
            ri_rpt = recent_rpt.get("items", [])
            if ri_rpt and ri_rpt[0].get("status") == "completed":
                st.info(
                    "T√°c v·ª• **Xu·∫•t b√°o c√°o thu·∫ø** ƒë√£ ch·∫°y xong nh∆∞ng kh√¥ng t·∫°o b√°o c√°o ‚Äî "
                    "c√≥ th·ªÉ ch∆∞a c√≥ d·ªØ li·ªáu b√∫t to√°n ho·∫∑c mirror Acct* tr·ªëng.\n\n"
                    f"M√£ t√°c v·ª• g·∫ßn nh·∫•t: `{ri_rpt[0].get('run_id', '')[:12]}‚Ä¶`"
                )
            else:
                st.info("Ch∆∞a c√≥ b√°o c√°o. Ch·∫°y **Xu·∫•t b√°o c√°o thu·∫ø** ·ªü tab T·∫°o t√°c v·ª•.")
        except Exception:
            st.info("Ch∆∞a c√≥ b√°o c√°o. Ch·∫°y **Xu·∫•t b√°o c√°o thu·∫ø** ·ªü tab T·∫°o t√°c v·ª•.")


# ===== TAB 6: D√≤ng ti·ªÅn ===============================================
with tab_cashflow:
    col_cf_hdr, col_cf_ref = st.columns([3, 1])
    with col_cf_hdr:
        st.subheader("üí∞ D·ª± b√°o d√≤ng ti·ªÅn")
    with col_cf_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_cashflow"):
            st.rerun()

    try:
        cf_data = _get("/agent/v1/acct/cashflow_forecast", params={"limit": 100})
        cf_items = cf_data.get("items", [])
        cf_summary = cf_data.get("summary", {})
    except Exception as e:
        st.error(f"L·ªói t·∫£i d·ª± b√°o d√≤ng ti·ªÅn: {e}")
        cf_items = []
        cf_summary = {}

    if cf_summary:
        col_in, col_out, col_net = st.columns(3)
        with col_in:
            st.metric("T·ªïng thu d·ª± ki·∫øn", f"{cf_summary.get('total_inflow', 0):,.0f} VND")
        with col_out:
            st.metric("T·ªïng chi d·ª± ki·∫øn", f"{cf_summary.get('total_outflow', 0):,.0f} VND")
        with col_net:
            net = cf_summary.get("net", 0)
            st.metric("R√≤ng", f"{net:,.0f} VND", delta=f"{net:,.0f}")

    if cf_items:
        df_cf = pd.DataFrame(cf_items)
        df_cf["H∆∞·ªõng"] = df_cf["direction"].map(lambda d: "üìà Thu" if d == "inflow" else "üìâ Chi")
        st.dataframe(
            df_cf[["forecast_date", "H∆∞·ªõng", "amount", "source_type", "source_ref", "confidence"]],
            use_container_width=True,
            column_config={
                "forecast_date": "Ng√†y d·ª± b√°o",
                "amount": "S·ªë ti·ªÅn (VND)",
                "source_type": "Ngu·ªìn",
                "source_ref": "Tham chi·∫øu",
                "confidence": "ƒê·ªô tin c·∫≠y",
            },
        )
    else:
        st.info("Ch∆∞a c√≥ d·ª± b√°o. Ch·∫°y **D·ª± b√°o d√≤ng ti·ªÅn** ·ªü tab T·∫°o t√°c v·ª•.")


# ===== TAB 7: Ch·ª©ng t·ª´ =================================================
with tab_voucher:
    col_vc_hdr, col_vc_ref = st.columns([3, 1])
    with col_vc_hdr:
        st.subheader("üì• Ch·ª©ng t·ª´ ƒë√£ nh·∫≠p")
    with col_vc_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_voucher"):
            st.rerun()

    try:
        voucher_data = _get("/agent/v1/acct/vouchers", params={"limit": 50})
        voucher_items = voucher_data.get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i ch·ª©ng t·ª´: {e}")
        voucher_items = []

    if voucher_items:
        df_vouchers = pd.DataFrame(voucher_items)
        display_cols = ["voucher_no", "date", "partner_name", "amount", "currency", "source", "type_hint"]
        if "classification_tag" in df_vouchers.columns:
            display_cols.append("classification_tag")
        available_cols = [c for c in display_cols if c in df_vouchers.columns]
        st.dataframe(
            df_vouchers[available_cols],
            use_container_width=True,
            column_config={
                "voucher_no": "S·ªë ch·ª©ng t·ª´",
                "date": "Ng√†y",
                "partner_name": "ƒê·ªëi t√°c",
                "amount": "S·ªë ti·ªÅn",
                "currency": "Ti·ªÅn t·ªá",
                "source": "Ngu·ªìn",
                "type_hint": "Lo·∫°i g·ª£i √Ω",
                "classification_tag": "Ph√¢n lo·∫°i",
            },
        )
    else:
        st.info("Ch∆∞a c√≥ ch·ª©ng t·ª´ n√†o. Ch·∫°y **Nh·∫≠p ch·ª©ng t·ª´** ·ªü tab T·∫°o t√°c v·ª•.")

    st.divider()
    st.subheader("üè∑Ô∏è Ph√¢n lo·∫°i ch·ª©ng t·ª´")

    try:
        cls_data = _get("/agent/v1/acct/voucher_classification_stats")
        cls_stats = cls_data.get("stats", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i th·ªëng k√™ ph√¢n lo·∫°i: {e}")
        cls_stats = []

    if cls_stats:
        df_cls = pd.DataFrame(cls_stats)
        # VN labels for classification tags
        _CLS_TAG_VN: dict[str, str] = {
            "PURCHASE_INVOICE": "H√≥a ƒë∆°n ƒë·∫ßu v√†o",
            "SALES_INVOICE": "H√≥a ƒë∆°n ƒë·∫ßu ra",
            "CASH_DISBURSEMENT": "Phi·∫øu chi",
            "CASH_RECEIPT": "Phi·∫øu thu",
            "PAYROLL": "L∆∞∆°ng",
            "FIXED_ASSET": "T√†i s·∫£n c·ªë ƒë·ªãnh",
            "TAX_DECLARATION": "K√™ khai thu·∫ø",
            "BANK_TRANSACTION": "Giao d·ªãch ng√¢n h√†ng",
            "OTHER": "Kh√°c",
        }
        if "classification_tag" in df_cls.columns:
            df_cls["Ph√¢n lo·∫°i VN"] = df_cls["classification_tag"].map(
                lambda t: _CLS_TAG_VN.get(t, t)
            )
        st.dataframe(
            df_cls,
            use_container_width=True,
            column_config={"classification_tag": "M√£ ph√¢n lo·∫°i", "Ph√¢n lo·∫°i VN": "Ph√¢n lo·∫°i", "count": "S·ªë l∆∞·ª£ng"},
        )

        tag_options = ["(t·∫•t c·∫£)"] + [s["classification_tag"] for s in cls_stats]
        selected_tag = st.selectbox("L·ªçc theo ph√¢n lo·∫°i", tag_options, key="cls_filter")
        if selected_tag != "(t·∫•t c·∫£)":
            try:
                filtered = _get(
                    "/agent/v1/acct/vouchers",
                    params={"classification_tag": selected_tag, "limit": 50},
                )
                filtered_items = filtered.get("items", [])
                if filtered_items:
                    df_f = pd.DataFrame(filtered_items)
                    st.dataframe(
                        df_f[["voucher_no", "date", "partner_name", "amount", "classification_tag"]],
                        use_container_width=True,
                        column_config={
                            "voucher_no": "S·ªë ch·ª©ng t·ª´",
                            "date": "Ng√†y",
                            "partner_name": "ƒê·ªëi t√°c",
                            "amount": "S·ªë ti·ªÅn",
                            "classification_tag": "Ph√¢n lo·∫°i",
                        },
                    )
                else:
                    st.info(f"Kh√¥ng c√≥ ch·ª©ng t·ª´ v·ªõi ph√¢n lo·∫°i '{selected_tag}'.")
            except Exception as e:
                st.error(f"‚ùå L·ªói: {e}")
    else:
        st.info("Ch∆∞a c√≥ th·ªëng k√™ ph√¢n lo·∫°i. Ch·∫°y **Ph√¢n lo·∫°i ch·ª©ng t·ª´** ·ªü tab T·∫°o t√°c v·ª•.")


# ===== TAB 8: H·ªèi ƒë√°p =================================================
with tab_qna:
    col_qn_hdr, col_qn_ref = st.columns([3, 1])
    with col_qn_hdr:
        st.subheader("üí¨ Tr·ª£ l√Ω h·ªèi ƒë√°p k·∫ø to√°n")
    with col_qn_ref:
        if st.button("üîÑ L√†m m·ªõi", key="refresh_qna"):
            st.rerun()

    qna_question = st.text_input(
        "Nh·∫≠p c√¢u h·ªèi k·∫ø to√°n b·∫±ng ti·∫øng Vi·ªát", value="", key="qna_input",
        placeholder="V√≠ d·ª•: Th√°ng 1/2026 c√≥ bao nhi√™u ch·ª©ng t·ª´?",
    )
    if st.button("üì® G·ª≠i c√¢u h·ªèi", key="qna_ask"):
        if qna_question.strip():
            with st.spinner("ƒêang x·ª≠ l√Ω c√¢u h·ªèi‚Ä¶"):
                try:
                    qna_res = _post("/agent/v1/acct/qna", {"question": qna_question.strip()})
                    st.success(qna_res.get("answer", "Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi."))
                    with st.expander("üìã Chi ti·∫øt x·ª≠ l√Ω"):
                        meta = qna_res.get("meta", {})
                        # Show only non-sensitive meta (no reasoning_chain)
                        st.json({
                            k: v for k, v in meta.items()
                            if k not in ("reasoning_chain",)
                        })
                except Exception as e:
                    st.error(f"‚ùå L·ªói: {e}")
        else:
            st.warning("‚ö†Ô∏è Vui l√≤ng nh·∫≠p c√¢u h·ªèi tr∆∞·ªõc khi g·ª≠i.")

    with st.expander("üìú L·ªãch s·ª≠ h·ªèi ƒë√°p", expanded=False):
        try:
            qna_history = _get("/agent/v1/acct/qna_audits", params={"limit": 10})
            qna_items = qna_history.get("items", [])
        except Exception as e:
            st.error(f"L·ªói: {e}")
            qna_items = []

        if qna_items:
            for item in qna_items:
                st.markdown(f"**‚ùì {item.get('question', '')}**")
                st.markdown(f"üí° {item.get('answer', '')}")
                st.caption(f"üïê {item.get('created_at', '')}")
                st.divider()
        else:
            st.info("Ch∆∞a c√≥ l·ªãch s·ª≠ h·ªèi ƒë√°p.")


# ===== TAB 9: H·ª£p ƒë·ªìng (Labs) =========================================
with tab_contract:
    st.caption("Module h·ª£p ƒë·ªìng ‚Äî th·ª≠ nghi·ªám, kh√¥ng ph·∫£i ch·ª©c nƒÉng ch√≠nh.")
    st.info(
        "‚ö†Ô∏è **L∆∞u √Ω:** Agent ch·ªâ t√≥m t·∫Øt v√† gom b·∫±ng ch·ª©ng ƒë·ªÉ h·ªó tr·ª£ ƒë·ªçc hi·ªÉu. "
        "Quy·∫øt ƒë·ªãnh k·∫ø to√°n v·∫´n thu·ªôc v·ªÅ ng∆∞·ªùi d√πng."
    )

    try:
        cases = _get("/agent/v1/contract/cases", params={"limit": 50}).get("items", [])
    except Exception as e:
        st.error(f"L·ªói t·∫£i danh s√°ch h·ª£p ƒë·ªìng: {e}")
        cases = []

    if not cases:
        st.info("Ch∆∞a c√≥ h·ª£p ƒë·ªìng n√†o. Ch·∫°y **Nghƒ©a v·ª• h·ª£p ƒë·ªìng** ·ªü tab T·∫°o t√°c v·ª•.")
    else:
        case_labels = {c["case_id"]: f"{c['case_key']} ({c['status']})" for c in cases}
        case_id = st.selectbox("Ch·ªçn h·ª£p ƒë·ªìng", list(case_labels.keys()), format_func=lambda cid: case_labels[cid])

        CONFIDENCE_THRESHOLD = 0.75
        CANDIDATE_LIMIT = 5

        colC, colD = st.columns(2)
        with colC:
            st.markdown("### Nghƒ©a v·ª• ‚Äî Tier B")
            try:
                obligations = _get(f"/agent/v1/contract/cases/{case_id}/obligations").get("items", [])
                if obligations:
                    high_conf = [o for o in obligations if o.get("confidence", 0) >= CONFIDENCE_THRESHOLD]
                    candidates = [o for o in obligations if o.get("confidence", 0) < CONFIDENCE_THRESHOLD]

                    _type_priority = {"payment": 0, "penalty": 1, "discount": 2}
                    candidates.sort(
                        key=lambda o: (
                            _type_priority.get(o.get("obligation_type", ""), 99),
                            -(o.get("confidence", 0)),
                        )
                    )

                    st.markdown(f"#### ‚úÖ ƒê·ªô tin c·∫≠y cao ({len(high_conf)})")
                    if high_conf:
                        df_high = pd.DataFrame(high_conf)
                        st.dataframe(
                            df_high[[
                                "obligation_type", "risk_level", "confidence",
                                "amount_value", "amount_percent", "due_date",
                            ]],
                            use_container_width=True,
                            column_config={
                                "obligation_type": "Lo·∫°i nghƒ©a v·ª•",
                                "risk_level": "M·ª©c r·ªßi ro",
                                "confidence": "ƒê·ªô tin c·∫≠y",
                                "amount_value": "Gi√° tr·ªã",
                                "amount_percent": "T·ª∑ l·ªá %",
                                "due_date": "H·∫°n tr·∫£",
                            },
                        )
                    else:
                        st.caption("Kh√¥ng c√≥ nghƒ©a v·ª• ƒë·ªô tin c·∫≠y cao.")

                    visible_candidates = candidates[:CANDIDATE_LIMIT]
                    hidden_count = max(0, len(candidates) - CANDIDATE_LIMIT)
                    st.markdown(f"#### üîç ·ª®ng vi√™n ({len(candidates)})")
                    if visible_candidates:
                        df_cand = pd.DataFrame(visible_candidates)
                        st.dataframe(
                            df_cand[[
                                "obligation_type", "risk_level", "confidence",
                                "amount_value", "amount_percent", "due_date",
                            ]],
                            use_container_width=True,
                        )
                        if hidden_count > 0:
                            with st.expander(f"Xem th√™m ({hidden_count} ·ª©ng vi√™n)"):
                                df_rest = pd.DataFrame(candidates[CANDIDATE_LIMIT:])
                                st.dataframe(
                                    df_rest[[
                                        "obligation_type", "risk_level", "confidence",
                                        "amount_value", "amount_percent", "due_date",
                                    ]],
                                    use_container_width=True,
                                )
                    else:
                        st.caption("Kh√¥ng c√≥ ·ª©ng vi√™n.")

                    st.markdown("#### üìù ƒê√°nh gi√°")
                    all_displayed = high_conf + visible_candidates
                    if all_displayed:
                        fb_idx = st.selectbox(
                            "Ch·ªçn nghƒ©a v·ª• ƒë·ªÉ ƒë√°nh gi√°",
                            range(len(all_displayed)),
                            format_func=lambda i: (
                                f"{all_displayed[i]['obligation_type']} "
                                f"(ƒë·ªô tin c·∫≠y={all_displayed[i].get('confidence', 0):.2f})"
                            ),
                            key="fb_select",
                        )
                        fb_cols = st.columns(2)
                        if _action_guard("fb_yes") or _action_guard("fb_no"):
                            st.caption("‚úî ƒê√£ ghi ƒë√°nh gi√° ‚Äî ƒëang l√†m m·ªõi‚Ä¶")
                        else:
                          with fb_cols[0]:
                            if st.button("‚úÖ ƒê√∫ng", key="fb_yes"):
                                try:
                                    _post(
                                        "/agent/v1/tier-b/feedback",
                                        {
                                            "obligation_id": all_displayed[fb_idx]["obligation_id"],
                                            "feedback_type": "explicit_yes",
                                            "user_id": current_user or None,
                                        },
                                    )
                                    st.success("‚úÖ ƒê√£ ghi ƒë√°nh gi√°: ƒê√∫ng")
                                    _mark_done("fb_yes")
                                    st.rerun()
                                except Exception as ex:
                                    st.error(f"‚ùå L·ªói: {ex}")
                          with fb_cols[1]:
                            if st.button("‚ùå Sai", key="fb_no"):
                                try:
                                    _post(
                                        "/agent/v1/tier-b/feedback",
                                        {
                                            "obligation_id": all_displayed[fb_idx]["obligation_id"],
                                            "feedback_type": "explicit_no",
                                            "user_id": current_user or None,
                                        },
                                    )
                                    st.success("‚ùå ƒê√£ ghi ƒë√°nh gi√°: Sai")
                                    _mark_done("fb_no")
                                    st.rerun()
                                except Exception as ex:
                                    st.error(f"‚ùå L·ªói: {ex}")
                else:
                    st.info("Ch∆∞a c√≥ d·ªØ li·ªáu nghƒ©a v·ª•. H√£y ch·∫°y ph√¢n t√≠ch h·ª£p ƒë·ªìng tr∆∞·ªõc.")
            except Exception as e:
                st.error(f"‚ùå L·ªói t·∫£i nghƒ©a v·ª•: {e}")

        with colD:
            st.markdown("### ƒê·ªÅ xu·∫•t")
            try:
                proposals = _get(f"/agent/v1/contract/cases/{case_id}/proposals").get("items", [])
                if proposals:
                    df_prop = pd.DataFrame(proposals)
                    cols = [
                        "proposal_id", "proposal_type", "tier", "risk_level",
                        "status", "created_by", "approvals_approved", "approvals_required",
                    ]
                    st.dataframe(
                        df_prop[cols],
                        use_container_width=True,
                        column_config={
                            "proposal_id": "M√£ ƒë·ªÅ xu·∫•t",
                            "proposal_type": "Lo·∫°i",
                            "tier": "C·∫•p",
                            "risk_level": "M·ª©c r·ªßi ro",
                            "status": "Tr·∫°ng th√°i",
                            "created_by": "Ng∆∞·ªùi t·∫°o",
                            "approvals_approved": "ƒê√£ duy·ªát",
                            "approvals_required": "C·∫ßn duy·ªát",
                        },
                    )
                    proposal_id = st.text_input(
                        "M√£ ƒë·ªÅ xu·∫•t xem chi ti·∫øt", value=df_prop.iloc[0]["proposal_id"], key="ct_pid",
                    )
                else:
                    st.info("Ch∆∞a c√≥ ƒë·ªÅ xu·∫•t.")
                    proposal_id = ""
            except Exception as e:
                st.error(f"‚ùå L·ªói t·∫£i ƒë·ªÅ xu·∫•t: {e}")
                proposals = []
                proposal_id = ""

            if proposal_id:
                selected = next((p for p in proposals if p["proposal_id"] == proposal_id), None)
                if selected:
                    st.markdown("#### Chi ti·∫øt ƒë·ªÅ xu·∫•t")
                    st.json(selected)

                    try:
                        approvals = (
                            _get(f"/agent/v1/contract/proposals/{proposal_id}/approvals").get("items", [])
                        )
                    except Exception:
                        approvals = []
                    if approvals:
                        st.markdown("#### Ph√™ duy·ªát")
                        st.dataframe(pd.DataFrame(approvals), use_container_width=True)

                    proposal_status = selected.get("status", "")
                    is_finalized = proposal_status in {"approved", "rejected"}

                    if is_finalized:
                        _label = "‚úÖ ƒê√£ duy·ªát" if proposal_status == "approved" else "‚ùå ƒê√£ t·ª´ ch·ªëi"
                        st.info(f"{_label} ‚Äî tr·∫°ng th√°i: **{proposal_status}**")

                    evidence_ack = st.checkbox(
                        "T√¥i ƒë√£ xem x√©t b·∫±ng ch·ª©ng", value=False, disabled=is_finalized, key="ct_ack",
                    )
                    note = st.text_input("Ghi ch√∫ (t√πy ch·ªçn)", value="", disabled=is_finalized, key="ct_note")

                    maker = (selected.get("created_by") or "").strip()
                    if maker and maker == current_user:
                        st.warning("‚ö†Ô∏è Maker-checker: b·∫°n kh√¥ng th·ªÉ duy·ªát ƒë·ªÅ xu·∫•t do ch√≠nh m√¨nh t·∫°o.")
                        can_act = False
                    else:
                        can_act = not is_finalized

                    _gk_ct_a = f"ct_approve_{proposal_id}"
                    _gk_ct_r = f"ct_reject_{proposal_id}"
                    if _action_guard(_gk_ct_a) or _action_guard(_gk_ct_r):
                        st.caption("‚úî ƒê√£ x·ª≠ l√Ω ‚Äî ƒëang l√†m m·ªõi‚Ä¶")
                    else:
                        colX, colY = st.columns(2)
                        with colX:
                            if st.button("‚úÖ Duy·ªát", disabled=(not can_act) or (not evidence_ack), key=_gk_ct_a):
                                try:
                                    _post(
                                        f"/agent/v1/contract/proposals/{proposal_id}/approvals",
                                        {
                                            "decision": "approve",
                                            "approver_id": current_user,
                                            "evidence_ack": evidence_ack,
                                            "note": note or None,
                                        },
                                    )
                                    _mark_done(_gk_ct_a)
                                    st.success("‚úÖ ƒê√£ g·ª≠i ph√™ duy·ªát")
                                    st.rerun()
                                except Exception as e:
                                    st.error(f"‚ùå {e}")
                        with colY:
                            if st.button("‚ùå T·ª´ ch·ªëi", disabled=(not can_act) or (not evidence_ack), key=_gk_ct_r):
                                try:
                                    _post(
                                        f"/agent/v1/contract/proposals/{proposal_id}/approvals",
                                        {
                                            "decision": "reject",
                                            "approver_id": current_user,
                                            "evidence_ack": evidence_ack,
                                            "note": note or None,
                                        },
                                    )
                                    _mark_done(_gk_ct_r)
                                    st.success("‚ùå ƒê√£ t·ª´ ch·ªëi ƒë·ªÅ xu·∫•t")
                                    st.rerun()
                                except Exception as e:
                                    st.error(f"‚ùå {e}")


# ===== TAB 10: Command Center (VN Agent) ==================================
with tab_command_center:
    st.subheader("üéõÔ∏è Command Center ‚Äî VN Invoice Data Stream")
    st.caption("Qu·∫£n l√Ω ngu·ªìn d·ªØ li·ªáu ho√° ƒë∆°n VN ‚Äî Kaggle + Synthetic ‚Üí Agent Pipeline")

    # --- Refresh controls ---
    _cc_ctrl_col1, _cc_ctrl_col2 = st.columns([3, 1])
    with _cc_ctrl_col2:
        if st.button("üîÑ L√†m m·ªõi", key="cc_refresh"):
            st.rerun()
    with _cc_ctrl_col1:
        from datetime import datetime as _dt
        st.caption(f"C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: {_dt.now().strftime('%H:%M:%S %d/%m/%Y')}")

    # Auto-refresh toggle (every 10s)
    _auto_refresh = st.checkbox("T·ª± ƒë·ªông l√†m m·ªõi (10 gi√¢y)", value=False, key="cc_auto_refresh")
    if _auto_refresh:
        time.sleep(10)
        st.rerun()

    # --- Feeder Status ---
    _cc_status: dict = {}
    try:
        _cc_status = _get("/agent/v1/vn_feeder/status")
    except Exception:
        _cc_status = {"running": False, "total_events_today": 0, "sources": []}

    _cc_running = _cc_status.get("running", False)
    _cc_badge_color = "#34a853" if _cc_running else "#ea4335"
    _cc_badge_text = "‚óè ƒêang ch·∫°y" if _cc_running else "‚óè ƒê√£ d·ª´ng"

    col_st1, col_st2, col_st3, col_st4 = st.columns(4)
    with col_st1:
        st.markdown(
            f'<span style="background:{_cc_badge_color};color:#fff;padding:4px 12px;'
            f'border-radius:12px;font-size:0.9em;">{_cc_badge_text}</span>',
            unsafe_allow_html=True,
        )
    with col_st2:
        st.metric("T·ªïng s·ª± ki·ªán h√¥m nay", _cc_status.get("total_events_today", 0))
    with col_st3:
        st.metric("Trung b√¨nh s·ª± ki·ªán/ph√∫t", _cc_status.get("avg_events_per_min", 0))
    with col_st4:
        _last_ev = _cc_status.get("last_event_at", "")
        st.metric("S·ª± ki·ªán g·∫ßn nh·∫•t", _last_ev[:19] if _last_ev else "‚Äî")

    st.divider()

    # --- Source Statistics ---
    st.markdown("##### üìä Ngu·ªìn d·ªØ li·ªáu")
    _cc_sources = _cc_status.get("sources", [])
    if _cc_sources:
        _src_df = pd.DataFrame(_cc_sources)
        _src_df.columns = ["Ngu·ªìn", "T·ªïng b·∫£n ghi", "ƒê√£ g·ª≠i", "% ƒë√£ d√πng"]
        st.dataframe(_src_df, use_container_width=True, hide_index=True)
    else:
        st.info("Ch∆∞a c√≥ d·ªØ li·ªáu ngu·ªìn. Kh·ªüi ƒë·ªông Feeder ƒë·ªÉ b·∫Øt ƒë·∫ßu.")

    st.divider()

    # --- Controls ---
    st.markdown("##### üéÆ ƒêi·ªÅu khi·ªÉn Feeder")

    # Use session state to track pending operations and avoid stale disable logic
    if "cc_pending_action" not in st.session_state:
        st.session_state["cc_pending_action"] = None

    col_c1, col_c2, col_c3 = st.columns(3)

    with col_c1:
        # Start: only visually indicate when already running, but always allow click
        _start_label = "‚ñ∂Ô∏è Kh·ªüi ƒë·ªông" if not _cc_running else "‚ñ∂Ô∏è Kh·ªüi ƒë·ªông (ƒëang ch·∫°y)"
        if st.button(_start_label, key="cc_start"):
            try:
                resp = _post("/agent/v1/vn_feeder/control", {"action": "start"})
                st.success(f"‚úÖ Feeder ƒë√£ kh·ªüi ƒë·ªông ‚Äî {resp.get('status', 'ok')}")
                time.sleep(1)  # brief delay for engine to update status
                st.rerun()
            except Exception as e:
                st.error(f"‚ùå Kh·ªüi ƒë·ªông th·∫•t b·∫°i: {e}")

    with col_c2:
        # Stop: ALWAYS allow click ‚Äî never disable. User must be able to stop.
        if st.button("‚èπÔ∏è D·ª´ng", key="cc_stop"):
            try:
                resp = _post("/agent/v1/vn_feeder/control", {"action": "stop"})
                st.success(f"‚úÖ Feeder ƒë√£ d·ª´ng ‚Äî {resp.get('status', 'ok')}")
                time.sleep(1)  # brief delay for engine to update status
                st.rerun()
            except Exception as e:
                st.error(f"‚ùå D·ª´ng th·∫•t b·∫°i: {e}")

    with col_c3:
        if st.button("‚ö° Inject ngay", key="cc_inject"):
            try:
                resp = _post("/agent/v1/vn_feeder/control", {"action": "inject_now"})
                st.success(f"‚úÖ ƒê√£ g·ª≠i l·ªánh inject ‚Äî {resp.get('status', 'ok')}")
                time.sleep(1)  # brief delay to let events process
                st.rerun()
            except Exception as e:
                st.error(f"‚ùå Inject th·∫•t b·∫°i: {e}")

    # Speed slider
    _cc_epm = st.slider(
        "T·ªëc ƒë·ªô (s·ª± ki·ªán/ph√∫t)",
        min_value=1,
        max_value=10,
        value=3,
        key="cc_epm_slider",
    )
    if st.button("üíæ √Åp d·ª•ng t·ªëc ƒë·ªô", key="cc_apply_epm"):
        try:
            _post(
                "/agent/v1/vn_feeder/control",
                {"action": "start", "target_events_per_min": _cc_epm},
            )
            st.success(f"‚úÖ ƒê√£ ƒë·∫∑t t·ªëc ƒë·ªô = {_cc_epm} s·ª± ki·ªán/ph√∫t")
        except Exception as e:
            st.error(f"‚ùå {e}")

    st.divider()

    # --- TT133 Quick Lookup ---
    st.markdown("##### üìñ Tra c·ª©u TT133/2016/TT-BTC")
    _tt_query = st.text_input(
        "T·ª´ kho√° t√†i kho·∫£n / b√∫t to√°n",
        placeholder="V√≠ d·ª•: ti·ªÅn m·∫∑t, mua h√†ng, 156, VAT...",
        key="cc_tt133_query",
    )
    if _tt_query:
        try:
            from accounting_agent.regulations.tt133_index import (
                get_regulation_context,
            )
            _tt_ctx = get_regulation_context(_tt_query)
            st.code(_tt_ctx, language="text")
        except Exception as e:
            st.error(f"L·ªói tra c·ª©u TT133: {e}")

    st.divider()

    # --- Recent Feeder Runs ---
    st.markdown("##### üìú T√°c v·ª• g·∫ßn ƒë√¢y t·ª´ Feeder")
    try:
        _feeder_runs = _get(
            "/agent/v1/runs",
            params={"run_type": "voucher_ingest", "limit": 5},
        ).get("items", [])
        if _feeder_runs:
            for _fr in _feeder_runs:
                _fr_status = _STATUS_LABELS.get(_fr.get("status", ""), _fr.get("status", ""))
                _fr_time = str(_fr.get("created_at", ""))[:19]
                _fr_stats = _fr.get("stats") or {}
                _fr_info = ""
                if isinstance(_fr_stats, dict):
                    _fr_parts = [f"{k}: {v}" for k, v in _fr_stats.items()]
                    _fr_info = " ‚Ä¢ ".join(_fr_parts[:3])
                st.markdown(
                    f"- **{_fr_time}** ‚Äî {_fr_status}"
                    + (f" ‚Äî {_fr_info}" if _fr_info else "")
                )
        else:
            st.info("Ch∆∞a c√≥ t√°c v·ª• voucher_ingest n√†o.")
    except Exception as e:
        st.error(f"L·ªói t·∫£i l·ªãch s·ª≠: {e}")
